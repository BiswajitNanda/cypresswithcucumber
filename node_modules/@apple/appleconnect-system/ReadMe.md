# 2SV Node Library
A library implementing 2-step verification (2SV) for Node.js ECMA-5.  
 Only works for **_System Accounts_** 
Works on either AppleConnect 'PROD' or 'UAT' environments.  
Requires a number of properties, best set via environment variables (or PIE/RIO secrets)
There are 2 sets of properties which must be set but require a choice:
Either
- secretTOTPkey - the TOTP generation key  
or
- secretFile - path to a file containing the TOTP generation key

And  
either
- appId - the IDMS app id
- appPassword - the IDMS App administrator password  
or
- appIdKey - the IDMS app secret key

Remaining properties are:
- environment - AppleConnect environnent (either 'PROD' or 'UAT')
- systemUserName - System Account username
- systemPassword - System Account password

## Usage
Install @apple/appleconnect-system from npm.apple.com.  

```
npm i -S @apple/appleconnect-system
```
Create a new "REST" object with the required properties.  
Use the "getDAW" method to get the DAW token/cookie.  
Use the "getUserSession" method to get a session item.  

```javascript
var appleConnSys = require('@apple/appleconnect-system');
var environment = 'PROD' or 'UAT';
var 
r = new appleConnSys.REST({
  environment: environment,
  secretTOTPkey: appleConnSys.getSecret('MY_TOTP_SECRET'),
  systemUserName: appleConnSys.getSecret('MY_SYS_USERNAME'),
  systemPassword: appleConnSys.getSecret('MY_SYS_PASSWORD'),
  appIdKey: appleConnSys.getSecret('MY_APP_ID_KEY')
});

r.getDAW(function(e, r) {
    assert.ifError(e);
    var cookie = r;
    // do something with the cookie
});

// to get the session:
r.getUserSession(function(e, r) {
    assert.ifError(e);
    var session = r;
    // do something with the session
});
```
## Testing
Expects the following environment variables (or PIE/RIO secrets):
 - AUTH_SYSUSER - Apple Connect system account username
 - AUTH_SYSPASS - Apple Connect system account password  

and either
 - AUTH_APPID - IDMS-generated App Id
 - AUTH_APPID_KEY - IDMS-generated App Key  
or
 - AUTH_APP_PASS - App Administrator password  

and either
 - AUTH_SYSTOTP_KEY - TOTP generator secret key  
or
- 'filename path of file containing TOTP generator secret key'
